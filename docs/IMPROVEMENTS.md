# ğŸ‰ LangChain Agent ä¿®å¤å’Œæ”¹è¿›æ€»ç»“

## ğŸ”§ ä¿®å¤çš„é—®é¢˜

### 1. **Structured Chat Agent è¾“å‡ºè§£æé”™è¯¯**
**é—®é¢˜**: `structured_chat` agent å‡ºç° "Could not parse LLM output" é”™è¯¯
**åŸå› **: Prompt æ¨¡æ¿ç¼ºå°‘å¿…éœ€çš„å˜é‡ `{tool_names}` å’Œæ ¼å¼ä¸æ­£ç¡®
**è§£å†³æ–¹æ¡ˆ**: 
- é‡æ–°è®¾è®¡äº† `structured_chat` agent çš„ prompt æ¨¡æ¿
- æ·»åŠ äº†æ‰€æœ‰å¿…éœ€çš„å˜é‡ï¼š`tools`, `tool_names`, `chat_history`, `agent_scratchpad`
- ä½¿ç”¨æ›´ç®€å•çš„æŒ‡ä»¤æ ¼å¼ï¼Œå…è®¸ç›´æ¥å›å¤ç®€å•å¯¹è¯
- æ·»åŠ äº†æ˜ç¡®çš„ç¤ºä¾‹æŒ‡å¯¼ agent ä½•æ—¶ä½¿ç”¨å·¥å…·ï¼Œä½•æ—¶ç›´æ¥å›å¤

### 2. **Chat History å˜é‡é”™è¯¯**
**é—®é¢˜**: "Input to PromptTemplate is missing variables {'chat_history'}" é”™è¯¯
**åŸå› **: ä¸åŒ agent ç±»å‹å¯¹å†å²è®°å½•æ ¼å¼è¦æ±‚ä¸åŒ
**è§£å†³æ–¹æ¡ˆ**:
- `tool_calling` agent: ä½¿ç”¨ `ChatPromptTemplate` + æ ‡å‡† `RunnableWithMessageHistory`
- `react` å’Œ `structured_chat` agent: ä½¿ç”¨ `PromptTemplate` + è‡ªå®šä¹‰å†å²è®°å½•è½¬æ¢
- åˆ›å»ºäº†æ™ºèƒ½çš„å†å²è®°å½•å¤„ç†åŒ…è£…å™¨

### 3. **StreamingCallbackHandler API é”™è¯¯** â­ æ–°å¢
**é—®é¢˜**: "StreamlitAPIException" é”™è¯¯ï¼Œåœ¨é Streamlit ç¯å¢ƒä¸­è°ƒç”¨ Streamlit å‡½æ•°
**åŸå› **: å›è°ƒå‡½æ•°ç›´æ¥è°ƒç”¨ Streamlit API è€Œæ²¡æœ‰é”™è¯¯å¤„ç†
**è§£å†³æ–¹æ¡ˆ**:
- æ·»åŠ äº† `_safe_streamlit_call()` æ–¹æ³•è¿›è¡Œå®‰å…¨çš„ API è°ƒç”¨
- æ‰€æœ‰ Streamlit æ“ä½œéƒ½åŒ…è£…åœ¨é”™è¯¯å¤„ç†ä¸­
- åœ¨é Streamlit ç¯å¢ƒä¸­ä¼˜é›…é™çº§ï¼Œä¸ä¼šå´©æºƒ

### 4. **Streamlit Expander åµŒå¥—é”™è¯¯** â­ æœ€æ–°ä¿®å¤
**é—®é¢˜**: "Expanders may not be nested inside other expanders" é”™è¯¯
**åŸå› **: åœ¨ expander å†…éƒ¨åµŒå¥—å…¶ä»– expander ç»„ä»¶
**è§£å†³æ–¹æ¡ˆ**:
- é‡æ–°è®¾è®¡äº†æ€è€ƒè¿‡ç¨‹å±•ç¤ºå¸ƒå±€
- ä½¿ç”¨ç®€å•çš„æ ‡é¢˜å’Œå®¹å™¨è€Œä¸æ˜¯åµŒå¥— expander
- ä¿æŒæ¸…æ™°çš„å±‚æ¬¡ç»“æ„å’Œå¯è¯»æ€§

### 5. **Structured Chat æ ¼å¼å…¼å®¹æ€§** â­ æœ€æ–°ä¿®å¤
**é—®é¢˜**: Agent è¾“å‡ºæ ¼å¼ä¸ LangChain è§£æå™¨ä¸å…¼å®¹
**åŸå› **: `create_structured_chat_agent` çš„å¤æ‚æ ¼å¼è¦æ±‚å¯¼è‡´è§£æå¤±è´¥
**è§£å†³æ–¹æ¡ˆ**:
- **æœ€ç»ˆæ–¹æ¡ˆ**: è®© `structured_chat` ä½¿ç”¨ä¸ `tool_calling` ç›¸åŒçš„å®ç°
- ä½¿ç”¨ `ChatPromptTemplate` + `create_tool_calling_agent`
- å®Œå…¨é¿å…äº†å¤æ‚çš„æ ¼å¼è§£æé—®é¢˜
- ä¿æŒäº†æ‰€æœ‰åŠŸèƒ½çš„å®Œæ•´æ€§

### 6. **Agent ç±»å‹ç»Ÿä¸€åŒ–** â­ æ¶æ„æ”¹è¿›
**æ”¹è¿›**: ç®€åŒ–äº† agent ç±»å‹çš„å®ç°å¤æ‚åº¦
**æ–¹æ³•**:
- `tool_calling` å’Œ `structured_chat`: ä½¿ç”¨ç›¸åŒçš„å¯é å®ç°
- `react`: ä¿æŒç‹¬ç‰¹çš„æ¨ç†å±•ç¤ºç‰¹æ€§
- ç»Ÿä¸€çš„å†å²è®°å½•å¤„ç†å’Œæµå¼å“åº”

### 9. **æ¨ç†è¿‡ç¨‹å±•ç¤ºä¼˜åŒ–** â­ æœ€æ–°ä¿®å¤
**é—®é¢˜**: å¤šè½®å¯¹è¯åæ¨ç†å±•ç¤ºå˜å¾—æ··ä¹±ï¼Œå‡ºç°é‡å¤æ­¥éª¤å’Œä¸åˆç†çš„å¸ƒå±€
**åŸå› **: 
- æ­¥éª¤è®¡æ•°å™¨ç®¡ç†ä¸å½“ï¼Œå¯¼è‡´é‡å¤çš„æ­¥éª¤ç¼–å·
- å®¹å™¨é‡å¤ä½¿ç”¨ï¼Œé€ æˆä¿¡æ¯é‡å 
- ç¼ºä¹æ¸…æ™°çš„è§†è§‰åˆ†ç¦»

**è§£å†³æ–¹æ¡ˆ**:
- **é‡æ–°è®¾è®¡ StreamingCallbackHandler**: ä½¿ç”¨ç‹¬ç«‹çš„æ­¥éª¤è®¡æ•°å™¨å’Œå®¹å™¨ç®¡ç†
- **æ¸…æ™°çš„æ­¥éª¤åˆ†ç¦»**: æ¯ä¸ªæ€è€ƒå’Œå·¥å…·ä½¿ç”¨æ­¥éª¤éƒ½æœ‰ç‹¬ç«‹çš„å®¹å™¨
- **æ”¹è¿›çš„è§†è§‰å±‚æ¬¡**: ä½¿ç”¨ `####` æ ‡é¢˜å’Œåˆ†éš”çº¿åˆ›å»ºæ¸…æ™°çš„ç»“æ„
- **æ™ºèƒ½å†…å®¹å±•ç¤º**: é•¿å†…å®¹è‡ªåŠ¨æŠ˜å ï¼ŒçŸ­å†…å®¹ç›´æ¥æ˜¾ç¤º

**æ”¹è¿›çš„å±•ç¤ºç»“æ„**:
```
### ğŸ§  Agent Reasoning Process
---
#### ğŸ¤” Step 1: Agent Thinking
ğŸ’­ Thinking: [æ€è€ƒå†…å®¹]
ğŸ“ View Full Reasoning [å¯å±•å¼€]

#### ğŸ”§ Step 2: Using Tool
Tool: calculator
Input: 15 * 23
âœ… Tool execution completed
ğŸ“‹ View Tool Output [å¯å±•å¼€]

---
### ğŸ’¬ Final Response
```

**æŠ€æœ¯æ”¹è¿›**:
- ç§»é™¤äº†é‡å¤çš„ `on_agent_action` å›è°ƒ
- ä½¿ç”¨ç‹¬ç«‹çš„å ä½ç¬¦é¿å…å†…å®¹è¦†ç›–
- æ·»åŠ äº†æ™ºèƒ½çš„å†…å®¹é•¿åº¦å¤„ç†
- æ”¹è¿›äº†é”™è¯¯å¤„ç†å’ŒçŠ¶æ€ç®¡ç†

### âœ… æœ€ç»ˆéªŒè¯

æ‰€æœ‰å·²çŸ¥é—®é¢˜éƒ½å·²ä¿®å¤ï¼š
1. âœ… Structured Chat Agent è§£æé”™è¯¯ - **å·²ä¿®å¤**
2. âœ… Chat History å˜é‡é”™è¯¯ - **å·²ä¿®å¤**
3. âœ… StreamingCallbackHandler API é”™è¯¯ - **å·²ä¿®å¤**
4. âœ… Streamlit Expander åµŒå¥—é”™è¯¯ - **å·²ä¿®å¤**
5. âœ… Agent è¾“å‡ºæ ¼å¼å…¼å®¹æ€§ - **å·²ä¿®å¤**
6. âœ… æ¶æ„ä¼˜åŒ–å’Œç®€åŒ– - **å·²å®Œæˆ**
7. âœ… ç¤ºä¾‹æç¤ºæŒ‰é’®é—®é¢˜ - **å·²ä¿®å¤**
8. âœ… ç”¨æˆ·æ‰¹å‡†æœºåˆ¶å¾ªç¯è°ƒç”¨ - **å·²ä¿®å¤**
9. âœ… æ¨ç†è¿‡ç¨‹å±•ç¤ºä¼˜åŒ– - **å·²ä¿®å¤**

ç³»ç»Ÿç°åœ¨å¤„äºå®Œå…¨ç¨³å®šå’Œå¯ç”¨çŠ¶æ€ï¼ğŸ‰ 